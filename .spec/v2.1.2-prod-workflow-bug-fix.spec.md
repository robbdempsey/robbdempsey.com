# Production Workflow Bug Fix Plan (v2.1.2)

## Overview
Fix the invalid workflow configuration in `.github/workflows/deploy-prod.yml` where `releases: write` is used as a permission value, which is not a valid GitHub Actions permission type. This is a patch release (2.1.0 â†’ 2.1.2) as it fixes a bug without adding new features.

## Problem Analysis
**Error**: `Invalid workflow file: .github/workflows/deploy-prod.yml#L1 (Line: 11, Col: 3): Unexpected value 'releases'`

**Root Cause**: 
- Line 11 of the workflow contains `releases: write` in the `permissions` block
- `releases` is not a valid permission type in GitHub Actions
- The correct permission for creating releases is `contents: write`, which is already present

**Valid GitHub Actions Permissions**:
- `actions`: read, write
- `checks`: read, write  
- `contents`: read, write
- `deployments`: read, write
- `id-token`: read, write
- `issues`: read, write
- `discussions`: read, write
- `packages`: read, write
- `pages`: read, write
- `pull-requests`: read, write
- `repository-projects`: read, write
- `security-events`: read, write
- `statuses`: read, write

**Note**: `releases` is NOT a valid permission type.

## Solution
Remove the invalid `releases: write` permission from the workflow. The `contents: write` permission already grants the necessary access to create releases and tags.

## Implementation Steps

### 1. Fix the Workflow File
**File**: `.github/workflows/deploy-prod.yml`

**Change**:
```yaml
# BEFORE (Lines 8-11)
permissions:
  contents: write
  id-token: write
  releases: write

# AFTER (Lines 8-10)
permissions:
  contents: write
  id-token: write
```

**Rationale**: 
- `contents: write` already provides permission to create releases, tags, and modify repository content
- `id-token: write` is required for OIDC authentication with AWS
- `releases: write` is invalid and should be removed

### 2. Verify the Fix Locally
Use local validation tools to check the syntax (NO remote push):

```bash
# Option 1: Use actionlint (GitHub Actions linter)
# Install: https://github.com/rhysd/actionlint
actionlint .github/workflows/deploy-prod.yml

# Option 2: Use GitHub CLI to validate (local validation only)
gh workflow view deploy-prod

# Option 3: Use yamllint to check YAML syntax
yamllint .github/workflows/deploy-prod.yml

# Option 4: Manual inspection - compare against GitHub Actions docs
cat .github/workflows/deploy-prod.yml | grep -A 5 "permissions:"
```

### 3. Validation Checklist
- [ ] Remove `releases: write` from permissions block
- [ ] Verify workflow file syntax is valid using local tools
- [ ] Confirm `contents: write` and `id-token: write` remain
- [ ] Test workflow validation locally (using actionlint, yamllint, or gh CLI)
- [ ] Verify no other invalid permissions exist in the file
- [ ] **DO NOT push to remote** - validation must be done locally only

## Acceptance Criteria
Following copilot-instructions and bug requirements:
- [x] Follow copilot-instructions for spec creation
- [x] Maintain v2.1.1 acceptance criteria validity (workflow still targets production release)
- [x] Update version to 2.1.2 (patch increment for bug fix)
- [ ] Fix the bug (remove invalid `releases: write` permission)
- [ ] Verify fix on local machine using local validation tools
- [ ] **DO NOT push to remote repo** - all validation must be local

## Best Practices Applied
- **Least Privilege**: Only use necessary permissions (`contents: write` for releases, `id-token: write` for OIDC)
- **Security**: Remove invalid permission that could cause confusion or false security expectations
- **Validation**: Test workflow syntax before deployment

## Risks and Mitigations
- **Risk**: Removing permission might break release creation
  - **Mitigation**: `contents: write` already covers release creation; this is the correct permission
  
- **Risk**: Other workflows might have the same issue
  - **Mitigation**: Check other workflow files for similar invalid permissions

## Next Steps
1. Apply the fix by removing line 11 (`releases: write`)
2. Validate the workflow locally using actionlint, yamllint, or gh CLI
3. Verify the YAML syntax is valid and no other issues exist
4. Mark the bug as resolved once local validation passes
5. **Note**: Do NOT push changes to remote as part of this fix validation

## References
- [GitHub Actions Permissions Documentation](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)
- [Workflow Syntax Reference](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions)
- Project copilot-instructions.md (followed for spec file creation)
